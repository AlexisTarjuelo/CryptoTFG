{% extends "base.html" %}
{% block title %}{{ asset.Name }} - Cryptotfg{% endblock %}

{% block content %}
<!-- Bootstrap + estilos personalizados -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root {
    --accent: #6EF1B3;
    --card: #1e1e2f;
    --text: #ffffff;
    --border: #2e2e3f;
    --background: #121212;
    --predicted: #FFD93D;
  }

  body {
    background-color: var(--background);
    color: var(--text);
  }

  .card, .list-group-item, .form-control, .input-group-text, .table {
    background-color: var(--card);
    border-color: var(--border);
    color: var(--text);
  }

  .card-title, .nav-link, .form-label, .table th, h4, h5 {
    color: var(--accent);
  }

  .form-control:disabled, .form-control[readonly] {
    background-color: var(--card);
    color: var(--text);
  }

  .nav-tabs .nav-link {
    background-color: var(--card);
    border-color: var(--border);
    color: var(--text);
  }

  .nav-tabs .nav-link.active {
    background-color: var(--accent);
    color: #000;
  }

  .list-group-item {
    border-color: var(--border);
  }

  .table-striped > tbody > tr:nth-of-type(odd) {
    background-color: #2a2a3a;
  }

  .table-hover tbody tr:hover {
    background-color: #333344;
  }

  .range-btn {
    border: 1px solid var(--accent);
    color: var(--accent);
    background-color: transparent;
    transition: all 0.3s ease;
  }

  .range-btn:hover {
    background-color: var(--accent);
    color: #000;
    box-shadow: 0 0 10px var(--accent);
  }

  .range-btn.active {
    background-color: var(--accent);
    color: #000;
    box-shadow: 0 0 12px var(--accent);
  }
</style>

<div class="container py-4">
  <!-- Header -->
  <div class="d-flex align-items-center gap-3 mb-4">
    <img src="{{ asset.LogoURL }}" alt="{{ asset.Symbol }}" class="rounded-circle" width="60" height="60">
    <div>
      <h1 class="m-0" style="color: var(--accent);">{{ asset.Name }} ({{ asset.Symbol }})</h1>
      <p class="text-muted mb-0">ID Coin: {{ asset.id_coin }}</p>
    </div>
  </div>

  <!-- Main dashboard -->
  <div class="row mb-5">
    <!-- Stats -->
    <div class="col-lg-4 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Estadísticas</h5>
          <div class="row">
            <div class="col-6 mb-2"><strong>Market Cap:</strong><br><span>${{ latest_price.MarketCap | round(2) if latest_price else '-' }}</span></div>
            <div class="col-6 mb-2"><strong>Volumen 24h:</strong><br><span>${{ latest_price.TotalVolume | round(2) if latest_price else '-' }}</span></div>
            <div class="col-6 mb-2"><strong>FDV:</strong><br><span>${{ fdv | round(2) if fdv else '-' }}</span></div>
            <div class="col-6 mb-2"><strong>Vol/Mkt Cap:</strong><br><span>{{ vol_mkt_cap | round(2) if vol_mkt_cap else '-' }}%</span></div>
            <div class="col-6 mb-2"><strong>Total Supply:</strong><br><span>{{ total_supply }} {{ asset.Symbol }}</span></div>
            <div class="col-6 mb-2"><strong>Max Supply:</strong><br><span>{{ max_supply }} {{ asset.Symbol }}</span></div>
            <div class="col-6 mb-2"><strong>Circulating Supply:</strong><br><span>{{ circulating_supply }} {{ asset.Symbol }}</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="col-lg-8">
      <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
        <strong style="color: var(--accent);">Ver rango:</strong>
        <button class="btn btn-sm range-btn active" data-range="ALL">Últimos datos</button>
      </div>
      <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#priceChartTab">Precio</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#volumeChartTab">Volumen</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#marketcapChartTab">Market Cap</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#predictionChartTab">Predicción</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="priceChartTab"><canvas id="priceChart"></canvas></div>
        <div class="tab-pane fade" id="volumeChartTab"><canvas id="volumeChart"></canvas></div>
        <div class="tab-pane fade" id="marketcapChartTab"><canvas id="marketcapChart"></canvas></div>
        <div class="tab-pane fade" id="predictionChartTab"><canvas id="predictionChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Conversion -->
  <div class="mb-5">
    <h4 class="mb-3">Conversión {{ asset.Symbol }} a USD</h4>
    <div class="row">
      <div class="col-md-6">
        <div class="input-group">
          <input type="number" class="form-control" id="btcInput" placeholder="Cantidad en {{ asset.Symbol }}" value="1">
          <span class="input-group-text">{{ asset.Symbol }}</span>
          <span class="input-group-text">=</span>
          <input type="text" class="form-control" id="usdOutput" readonly>
          <span class="input-group-text">USD</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions -->
  <div class="mb-5">
    <h4 class="mb-3">Transacciones recientes</h4>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-bordered align-middle">
        <thead>
          <tr>
            <th>Hash</th>
            <th>Hora</th>
            <th>Monto</th>
            <th>Desde</th>
            <th>Hacia</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in transactions %}
            <tr>
              <td>{{ tx.TxHash[:10] }}...</td>
              <td>{{ tx.Timestamp.strftime('%H:%M UTC') }}</td>
              <td>{{ tx.Amount | round(4) }} {{ asset.Symbol }}</td>
              <td>{{ tx.FromAddress[:10] }}...</td>
              <td>{{ tx.ToAddress[:10] }}...</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-center text-muted">No hay transacciones recientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Noticias -->
  <div class="mb-5">
    <h4 class="mb-3">Noticias relacionadas</h4>
    <div class="row g-4">
      {% for news in related_news %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 border-0 shadow-sm">
            {% if news.Imagen %}
              <img src="{{ news.Imagen }}" class="card-img-top" alt="imagen noticia" style="height: 180px; object-fit: cover;">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">{{ news.Titulo or 'Sin título' }}</h6>
              <p class="card-text text-muted small mt-auto">{{ news.FechaPublicacion.strftime('%d/%m/%Y %H:%M') if news.FechaPublicacion else 'Fecha desconocida' }}</p>
              <a href="{{ news.URL or '#' }}" target="_blank" class="btn btn-sm mt-2 range-btn">Leer más</a>
            </div>
          </div>
        </div>
      {% else %}
        <div class="col-12">
          <div class="alert alert-secondary text-center">Aún no hay noticias para este activo.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ price_history | map(attribute='0') | map('string') | list | tojson }};
  const prices = {{ price_history | map(attribute='1') | list | tojson }};
  const volumes = prices.map(p => p * 1.3);
  const marketcaps = prices.map(p => p * 100);
  const predictions = prices.map((p, i) => p + Math.sin(i / 5) * 100 + i * 10);

  const createChart = (id, data, label, color, type = 'line', options = {}) => {
    new Chart(document.getElementById(id), {
      type,
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '22',
          tension: 0.3,
          fill: true,
          ...options
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
          y: { ticks: { color: '#ccc' }, grid: { color: '#333' } }
        }
      }
    });
  };

  createChart('priceChart', prices, '{{ asset.Symbol }} / USD', '#6EF1B3');
  createChart('volumeChart', volumes, 'Volumen', '#3EC894', 'bar');
  createChart('marketcapChart', marketcaps, 'Market Cap', '#FF6B6B', 'bar');
  createChart('predictionChart', predictions, 'Predicción', '#FFD93D', 'line', { borderDash: [10, 5], pointRadius: 0 });

  document.getElementById('btcInput').addEventListener('input', () => {
    const btc = parseFloat(document.getElementById('btcInput').value || 0);
    document.getElementById('usdOutput').value = (btc * {{ latest_price.PriceUSD if latest_price else 0 }}).toLocaleString(undefined, { minimumFractionDigits: 2 });
  });
  document.getElementById('btcInput').dispatchEvent(new Event('input'));
</script>
{% endblock %}