{% extends "base.html" %}
{% block title %}{{ asset.Name }} - Detalle{% endblock %}

{% block content %}
<style>
  .asset-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .asset-header img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
  }
  .asset-header h1 {
    font-size: 2rem;
    color: #6EF1B3;
  }
  .metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #3EC894;
    border-radius: 12px;
    padding: 1rem;
  }
  .metric {
    flex: 1;
    min-width: 200px;
  }
  .metric h4 {
    margin-bottom: 0.5rem;
    color: #6EF1B3;
  }
  .metric p {
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
  }
  .chart-box {
    border: 1px solid #3EC894;
    border-radius: 12px;
    margin-bottom: 2rem;
    padding: 1rem;
    background-color: #101823;
  }
  canvas {
    width: 100% !important;
    max-height: 300px !important;
  }
</style>

<div class="asset-header">
  <img src="{{ asset.LogoURL }}" alt="{{ asset.Symbol }}">
  <h1>{{ asset.Name }} ({{ asset.Symbol }})</h1>
</div>

<div class="metrics">
  <div class="metric">
    <h4>Último Precio</h4>
    <p>${{ '%.2f'|format(latest_price.PriceUSD if latest_price else 0) }}</p>
  </div>
  <div class="metric">
    <h4>Market Cap</h4>
    <p>${{ '{:,.0f}'.format(latest_price.MarketCap) if latest_price and latest_price.MarketCap else '-' }}</p>
  </div>
  <div class="metric">
    <h4>Volumen 24h</h4>
    <p>${{ '{:,.0f}'.format(latest_price.TotalVolume) if latest_price and latest_price.TotalVolume else '-' }}</p>
  </div>
  <div class="metric">
    <h4>Última actualización</h4>
    <p>{{ latest_price.RecordedAt.strftime('%Y-%m-%d %H:%M') if latest_price else '-' }}</p>
  </div>
</div>

<div class="chart-box">
  <canvas id="priceChart"></canvas>
</div>
<div class="chart-box">
  <canvas id="marketCapChart"></canvas>
</div>
<div class="chart-box">
  <canvas id="volumeChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ price_history | map(attribute='RecordedAt') | map('string') | list | tojson }};
  const prices = {{ price_history | map(attribute='PriceUSD') | map('default', 0) | list | tojson }};
  const marketCaps = {{ price_history | map(attribute='MarketCap') | map('default', 0) | list | tojson }};
  const volumes = {{ price_history | map(attribute='TotalVolume') | map('default', 0) | list | tojson }};

  const baseOptions = {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        mode: 'index',
        intersect: false,
      },
    },
    interaction: {
      mode: 'nearest',
      axis: 'x',
      intersect: false
    },
    scales: {
      x: {
        ticks: { color: '#6EF1B3' },
        grid: { color: 'rgba(110, 241, 179, 0.2)' }
      },
      y: {
        ticks: { color: '#6EF1B3' },
        grid: { color: 'rgba(110, 241, 179, 0.2)' }
      }
    }
  };

  new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Precio USD',
        data: prices,
        borderColor: '#6EF1B3',
        backgroundColor: 'rgba(62, 200, 148, 0.2)',
        tension: 0.3
      }]
    },
    options: baseOptions
  });

  new Chart(document.getElementById('marketCapChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Market Cap',
        data: marketCaps,
        borderColor: '#3EC894',
        backgroundColor: 'rgba(62, 200, 148, 0.1)',
        tension: 0.3
      }]
    },
    options: baseOptions
  });

  new Chart(document.getElementById('volumeChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Volumen 24h',
        data: volumes,
        borderColor: '#6EF1B3',
        backgroundColor: 'rgba(110, 241, 179, 0.1)',
        tension: 0.3
      }]
    },
    options: baseOptions
  });
</script>
{% endblock %}