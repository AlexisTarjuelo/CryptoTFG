{% extends "base.html" %}
{% block title %}Comparador de Criptomonedas{% endblock %}
{% block content %}
<style>
  h1 {
    color: var(--accent);
    text-align: center;
    margin-bottom: 2rem;
  }

  .guide-box {
    background-color: var(--header-bg);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    color: var(--text-color);
  }

  .guide-box h2 {
    color: var(--accent);
    margin-bottom: 1rem;
    font-size: 1.5rem;
  }

  .guide-box ul {
    padding-left: 1.5rem;
  }

  .guide-box li {
    margin-bottom: 0.5rem;
  }

  .selector-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .selector-button {
    width: 220px;
    height: 110px;
    border: 2px dashed var(--accent);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    background-color: transparent;
    transition: all 0.3s ease;
    flex-direction: column;
    color: inherit;
  }

  .selector-button:hover {
    box-shadow: 0 0 8px var(--accent);
  }

  .selector-button.active {
    background-color: var(--card);
    color: var(--text-color);
    border: 2px solid var(--accent);
  }

  body.light .selector-button.active {
    background-color: #e7fdf4;
    color: #000;
  }

  .suggestion-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    font-size: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 12px;
    z-index: 2;
    background-color: #fff;
    color: #000;
  }

  .suggestion-box {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background-color: var(--bg-color);
    border: 1px solid var(--accent);
    border-radius: 8px;
    z-index: 5;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
  }

  .suggestion-item {
    padding: 0.6rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .suggestion-item:hover {
    background-color: var(--header-bg);
  }

  .suggestion-item img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
  }

  .selector-content img {
    width: 36px;
    height: 36px;
    object-fit: cover;
    border-radius: 50%;
  }

  .chart-container {
    width: 100%;
    overflow-x: auto;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }
</style>


<div class="container py-4">
  <h1>Comparador de Criptomonedas</h1>

  <div class="guide-box">
    <h2>ðŸ“˜ Â¿CÃ³mo usar el comparador?</h2>
    <ul>
      <li>ðŸ“ˆ <strong>Selecciona hasta 4 criptomonedas</strong> haciendo clic en los recuadros con el sÃ­mbolo <code>+</code>. Puedes buscarlas por nombre o sÃ­mbolo.</li>
      <li>ðŸ§  El grÃ¡fico se actualiza automÃ¡ticamente al seleccionar una moneda.</li>
      <li>ðŸ“Š Puedes alternar entre ver la evoluciÃ³n del <strong>Precio</strong>, <strong>Volumen</strong> o <strong>CapitalizaciÃ³n de mercado</strong> desde el desplegable.</li>
      <li>ðŸ’¡ Esto te permite identificar fÃ¡cilmente quÃ© criptomoneda ha tenido un mejor desempeÃ±o relativo.</li>
    </ul>
  </div>

  <div class="selector-container" id="selectorContainer">
    <div class="selector-button" data-index="0">+</div>
    <div class="selector-button" data-index="1">+</div>
    <div class="selector-button" data-index="2">+</div>
    <div class="selector-button" data-index="3">+</div>
  </div>

  <div class="text-center mb-3">
    <label for="chartType" class="form-label">Ver grÃ¡fico de:</label>
    <select class="form-select mx-auto" style="max-width: 300px" id="chartType">
      <option value="price">Precio</option>
      <option value="volume">Volumen</option>
      <option value="marketcap">Market Cap</option>
    </select>
  </div>

  <div class="chart-container">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const maxCryptos = 4;
  const chartColors = ['#F7931A', '#627EEA', '#3CC8C8', '#9945FF'];
  let selectedCryptos = Array(maxCryptos).fill(null);
  let assetDataMap = {};
  let mainChart;
  let assets = [];

  async function fetchAssets() {
    const res = await fetch('/versus/assets');
    const json = await res.json();
    assets = json.assets;
  }

  async function fetchAssetData(symbol) {
    const res = await fetch(`/versus/data?symbol=${symbol}`);
    const json = await res.json();
    return {
      label: json.label,
      symbol: json.symbol,
      dates: json.data.map(d => d[0]),
      price: json.data.map(d => d[1]),
      volume: json.data.map(d => d[1] * 1.2),
      marketcap: json.data.map(d => d[1] * 1000)
    };
  }

  function updateChart() {
    const type = document.getElementById('chartType').value;
    const datasets = selectedCryptos.map((crypto, index) => {
      if (!crypto) return null;
      const data = assetDataMap[crypto.Symbol];
      return {
        label: crypto.Name,
        data: data[type],
        borderColor: chartColors[index],
        backgroundColor: chartColors[index] + '22',
        fill: false,
        tension: 0.3
      };
    }).filter(Boolean);
    const labels = datasets[0]?.data?.map((_, i) => assetDataMap[selectedCryptos.find(c => c)?.Symbol]?.dates[i]) || [];
    if (mainChart) {
      mainChart.data.labels = labels;
      mainChart.data.datasets = datasets;
      mainChart.update();
    } else {
      mainChart = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: getComputedStyle(document.body).getPropertyValue('--accent') } } },
          scales: {
            x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
            y: { ticks: { color: '#ccc' }, grid: { color: '#333' } }
          }
        }
      });
    }
  }

  document.getElementById('chartType').addEventListener('change', updateChart);

  document.addEventListener('DOMContentLoaded', async () => {
    await fetchAssets();
    const buttons = document.querySelectorAll('.selector-button');

    buttons.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('active')) {
          selectedCryptos[index] = null;
          btn.innerHTML = '+';
          btn.classList.remove('active');
          updateChart();
          return;
        }

        btn.innerHTML = `<input type="text" class="suggestion-input" placeholder="Buscar cripto..." />
                          <div class="suggestion-box"></div>`;
        const input = btn.querySelector('input');
        const box = btn.querySelector('.suggestion-box');

        input.focus();

        input.addEventListener('input', () => {
          const val = input.value.toLowerCase();
          box.innerHTML = '';
          assets.filter(a => a.Name.toLowerCase().includes(val) || a.Symbol.toLowerCase().includes(val)).forEach(asset => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerHTML = `<img src="${asset.LogoURL}" alt="${asset.Symbol}" /> ${asset.Name} (${asset.Symbol})`;
            div.addEventListener('click', async () => {
              const data = await fetchAssetData(asset.Symbol);
              assetDataMap[asset.Symbol] = data;
              selectedCryptos[index] = asset;
              btn.innerHTML = `<div class="selector-content">
                                  <img src="${asset.LogoURL}" alt="">
                                  <span>${asset.Name}</span>
                               </div>`;
              btn.classList.add('active');
              updateChart();
            });
            box.appendChild(div);
          });
        });

        setTimeout(() => {
          document.addEventListener('click', function clear(e) {
            if (!btn.contains(e.target)) {
              if (!selectedCryptos[index]) btn.innerHTML = '+';
              else btn.innerHTML = `<div class="selector-content">
                                      <img src="${selectedCryptos[index].LogoURL}" alt="">
                                      <span>${selectedCryptos[index].Name}</span>
                                   </div>`;
              document.removeEventListener('click', clear);
            }
          });
        }, 10);
      });
    });
  });
</script>
{% endblock %}
