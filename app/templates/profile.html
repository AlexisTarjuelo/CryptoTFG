{% extends "base.html" %}
{% block title %}Perfil - Cryptotfg{% endblock %}

{% block content %}
<style>
  .profile-container {
    max-width: 800px;
    margin: 0 auto;
    background-color: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
  }

  .profile-avatar {
    text-align: center;
    margin-bottom: 2rem;
  }

  .profile-avatar img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    cursor: pointer;
  }

  .profile-avatar button {
    margin-top: 0.5rem;
    background-color: var(--accent);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    color: var(--bg);
  }

  .profile-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .form-row .form-group {
    flex: 1;
    min-width: 45%;
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 0.25rem;
  }

  .form-group input[type="text"],
  .form-group input[type="password"],
  .form-group input[type="email"],
  .form-group input[type="tel"] {
    padding: 0.6rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    background-color: transparent;
    color: var(--text);
  }

  .form-actions {
    text-align: right;
    margin-top: 1.5rem;
  }

  .form-actions button {
    background-color: var(--accent);
    border: none;
    color: var(--bg);
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  .biometric-toggle {
    margin-top: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  @media (max-width: 600px) {
    .form-row .form-group {
      min-width: 100%;
    }
    .form-actions {
      text-align: center;
    }
  }
</style>

<div class="profile-container">
  <div class="profile-avatar">
    <img src="{{ url_for('static', filename='images/avatars/' ~ user.Avatar) }}" alt="Avatar" id="avatar-preview">
    <br>
    <button type="button" onclick="toggleAvatarPicker()">Cambiar avatar</button>
  </div>

  <form method="post" class="profile-form">
    {{ form.hidden_tag() }}
    <div class="form-row">
      <div class="form-group">{{ form.first_name.label }}{{ form.first_name }}</div>
      <div class="form-group">{{ form.last_name.label }}{{ form.last_name }}</div>
    </div>
    <div class="form-row">
      <div class="form-group">{{ form.second_last_name.label }}{{ form.second_last_name }}</div>
      <div class="form-group">{{ form.phone.label }}{{ form.phone }}</div>
    </div>
    <div class="form-row">
      <div class="form-group">{{ form.password.label }}{{ form.password }}</div>
      <div class="form-group">{{ form.confirm_password.label }}{{ form.confirm_password }}</div>
    </div>
    <div class="biometric-toggle">
      <input type="checkbox" id="enableBiometrics" onchange="startBiometricRegistration()">
      <label for="enableBiometrics">Activar acceso biométrico</label>
    </div>
    <div class="form-actions">
      {{ form.submit(class_='btn btn-primary') }}
    </div>
  </form>
</div>

<script>
  function toggleAvatarPicker() {
    alert("Aquí se mostraría una galería para elegir avatar.");
  }

  async function startBiometricRegistration() {
    if (!window.PublicKeyCredential) {
      alert("Tu navegador no soporta autenticación biométrica.");
      return;
    }

    const response = await fetch("/biometric/start-registration");
    const options = await response.json();

    options.challenge = Uint8Array.from(atob(options.challenge), c => c.charCodeAt(0));
    options.user.id = Uint8Array.from(atob(options.user.id), c => c.charCodeAt(0));

    const credential = await navigator.credentials.create({ publicKey: options });

    const credentialData = {
      id: credential.id,
      rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
      type: credential.type,
      response: {
        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
        attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject)))
      }
    };

    await fetch('/biometric/finish-registration', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(credentialData)
    });

    alert("Biometría activada correctamente ✅");
  }
</script>
{% endblock %}