{% extends "base.html" %}
{% block title %}AdministraciÃ³n de Usuarios{% endblock %}

{% block content %}
<style>
  .user-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
    gap: 1.5rem;
  }

  .user-card {
    background-color: var(--card);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    color: var(--text-color);
  }

  .user-card h5 {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
    color: var(--accent);
  }

  .user-card .meta {
    font-size: 0.9rem;
    line-height: 1.4;
  }

  .user-card .role {
    font-weight: bold;
    font-size: 0.85rem;
    color: var(--accent);
    text-transform: uppercase;
  }

  .user-card .role.user {
    color: #ffffffcc;
  }

  .user-card .actions {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .user-card .btn-edit,
  .user-card .btn-delete,
  .user-card .btn-role {
    background-color: var(--btn-edit-bg);
    color: var(--btn-edit-text);
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
  }

  .user-card .btn-delete {
    background-color: var(--btn-delete-bg);
    color: var(--btn-delete-text);
  }

  .user-card .btn-edit:hover,
  .user-card .btn-delete:hover,
  .user-card .btn-role:hover {
    opacity: 0.9;
  }
</style>

<h1 class="text-accent mb-4">AdministraciÃ³n de Usuarios</h1>

<div class="mb-4">
  <input type="text" class="form-control" id="userSearch" placeholder="ðŸ” Buscar por nombre, email o telÃ©fono..." style="max-width: 400px;">
</div>

<div class="user-grid">
  {% for user in users %}
  <div class="user-card" data-user="{{ user.FirstName }} {{ user.LastName }} {{ user.Email }} {{ user.Phone }}">
    <h5>{{ user.FirstName }} {{ user.LastName }}</h5>
    <div class="meta">
      ðŸ“§ {{ user.Email }}<br />
      ðŸ“± {{ user.Phone }}
    </div>
    <div class="role {{ user.Role|lower }}">{{ user.Role.capitalize() }}</div>
    <div class="actions">
      <button class="btn-edit" onclick="openEditModal({{ user.UserID }}, '{{ user.FirstName }}', '{{ user.LastName }}', '{{ user.Email }}', '{{ user.Phone }}', '{{ user.Role }}')">Editar</button>
      <button class="btn-role" onclick="toggleAdminRole({{ user.UserID }}, '{{ user.Role }}')">{% if user.Role == 'admin' %}Quitar admin{% else %}Hacer admin{% endif %}</button>
      <button class="btn-delete" onclick="deleteUser({{ user.UserID }})">Eliminar</button>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal de EdiciÃ³n Usuario -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Editar Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" id="editUserID">
          <div class="mb-3">
            <label for="editFirstName" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="editFirstName">
          </div>
          <div class="mb-3">
            <label for="editLastName" class="form-label">Apellidos</label>
            <input type="text" class="form-control" id="editLastName">
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail">
          </div>
          <div class="mb-3">
            <label for="editPhone" class="form-label">TelÃ©fono</label>
            <input type="text" class="form-control" id="editPhone">
          </div>
          <div class="mb-3">
            <label for="editRole" class="form-label">Rol</label>
            <select class="form-control" id="editRole">
              <option value="user">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-accent" onclick="submitUserEdit()">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function openEditModal(id, firstName, lastName, email, phone, role) {
    document.getElementById('editUserID').value = id;
    document.getElementById('editFirstName').value = firstName;
    document.getElementById('editLastName').value = lastName;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone;
    document.getElementById('editRole').value = role;

    new bootstrap.Modal(document.getElementById('editUserModal')).show();
  }

  function submitUserEdit() {
    const id = document.getElementById('editUserID').value;
    const data = {
      first_name: document.getElementById('editFirstName').value,
      last_name: document.getElementById('editLastName').value,
      email: document.getElementById('editEmail').value,
      phone: document.getElementById('editPhone').value,
      role: document.getElementById('editRole').value
    };

    fetch(`/admin/user/update/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("âœ… Usuario actualizado correctamente");
        location.reload();
      } else {
        alert("âŒ Error al actualizar usuario");
      }
    });
  }

  function deleteUser(userId) {
    if (confirm("Â¿EstÃ¡s seguro de eliminar este usuario?")) {
      fetch(`/admin/user/delete/${userId}`, {
  method: "DELETE",
  credentials: "include"
})
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("âœ… Usuario eliminado");
          location.reload();
        } else {
          alert(data.error || "âŒ Error al eliminar usuario");
        }
      });
    }
  }

  // âœ… NUEVA FUNCIÃ“N: Alternar rol admin/user
  function toggleAdminRole(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';

    fetch(`/admin/user/admin-update/${userId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ role: newRole })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(`âœ… Rol cambiado a ${newRole}`);
        location.reload();
      } else {
        alert("âŒ No se pudo cambiar el rol");
      }
    })
    .catch(error => {
      console.error("âŒ Error:", error);
      alert("âŒ Error al intentar cambiar el rol");
    });
  }

  const searchInput = document.getElementById('userSearch');
  const userCards = document.querySelectorAll('.user-card');

  searchInput?.addEventListener('input', function () {
    const query = this.value.toLowerCase();
    userCards.forEach(card => {
      const text = card.getAttribute('data-user').toLowerCase();
      card.style.display = text.includes(query) ? 'block' : 'none';
    });
  });
</script>


{% endblock %}
